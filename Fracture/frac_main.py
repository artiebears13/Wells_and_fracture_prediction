from hyperopt import hp, fmin, tpe, Trials
from generate_frac import calculate_fracture, compare_result
import numpy as np
import pandas as pd
from functools import partial

from matplotlib import pyplot as plt
# [{'loss': 3.4546373896742364, 'params': [[0.9, 0.0], [0.7000000000000001, 0.4]], 'status': 'ok'}, {'loss': 2.2979551912174596, 'params': [[0.2, 0.4], [0.9, 0.1]], 'status': 'ok'}, {'loss': 2.9095808668953023, 'params': [[0.8, 0.9], [0.7000000000000001, 0.2]], 'status': 'ok'}, {'loss': 2.0687542888994526, 'params': [[0.30000000000000004, 0.6000000000000001], [0.0, 0.30000000000000004]], 'status': 'ok'}, {'loss': 100, 'params': [[0.0, 0.30000000000000004], [0.2, 0.4]], 'status': 'fail'}, {'loss': 3.3143077081267047, 'params': [[0.2, 0.4], [0.0, 0.7000000000000001]], 'status': 'ok'}, {'loss': 100, 'params': [[0.8, 0.5], [0.8, 0.7000000000000001]], 'status': 'fail'}, {'loss': 2.2307620220083164, 'params': [[0.5, 0.5], [0.8, 0.8]], 'status': 'ok'}, {'loss': 1.2054147863697762, 'params': [[0.0, 0.2], [0.5, 0.30000000000000004]], 'status': 'ok'}, {'loss': 3.3615458349064924, 'params': [[0.6000000000000001, 0.1], [0.4, 0.6000000000000001]], 'status': 'ok'}, {'loss': 1.2741175432987548, 'params': [[0.0, 0.4], [0.5, 0.7000000000000001]], 'status': 'ok'}, {'loss': 100, 'params': [[0.4, 0.9], [0.30000000000000004, 0.7000000000000001]], 'status': 'fail'}, {'loss': 3.2629114178007783, 'params': [[0.4, 0.2], [0.1, 0.7000000000000001]], 'status': 'ok'}, {'loss': 100, 'params': [[0.8, 0.4], [0.7000000000000001, 0.4]], 'status': 'fail'}, {'loss': 3.0121823737619695, 'params': [[0.4, 0.5], [0.6000000000000001, 0.9]], 'status': 'ok'}, {'loss': 100, 'params': [[0.30000000000000004, 0.7000000000000001], [0.30000000000000004, 0.9]], 'status': 'fail'}, {'loss': 3.2997991710251418, 'params': [[0.8, 0.30000000000000004], [0.8, 0.7000000000000001]], 'status': 'ok'}, {'loss': 1.944761531835227, 'params': [[0.9, 0.9], [0.1, 0.2]], 'status': 'ok'}, {'loss': 3.5865131005512128, 'params': [[0.5, 0.9], [0.2, 0.9]], 'status': 'ok'}, {'loss': 1.7119804334278221, 'params': [[0.8, 0.30000000000000004], [0.0, 0.6000000000000001]], 'status': 'ok'}, {'loss': 1.2054147863697762, 'params': [[0.0, 0.2], [0.5, 0.30000000000000004]], 'status': 'ok'}, {'loss': 1.678392185073477, 'params': [[0.1, 0.2], [0.5, 0.30000000000000004]], 'status': 'ok'}, {'loss': 2.7392777049583126, 'params': [[0.7000000000000001, 0.8], [0.5, 0.5]], 'status': 'ok'}, {'loss': 1.2054147863697762, 'params': [[0.0, 0.2], [0.5, 0.30000000000000004]], 'status': 'ok'}, {'loss': 2.365354242501082, 'params': [[0.0, 0.2], [0.5, 0.0]], 'status': 'ok'}, {'loss': 1.2054147863697762, 'params': [[0.0, 0.2], [0.5, 0.30000000000000004]], 'status': 'ok'}, {'loss': 0.5666520249531131, 'params': [[0.0, 0.2], [0.6000000000000001, 0.30000000000000004]], 'status': 'ok'}, {'loss': 3.3780687234522375, 'params': [[0.7000000000000001, 0.0], [0.6000000000000001, 0.8]], 'status': 'ok'}, {'loss': 3.320314073644281, 'params': [[0.6000000000000001, 0.6000000000000001], [0.6000000000000001, 0.30000000000000004]], 'status': 'ok'}, {'loss': 3.3068615241850363, 'params': [[0.1, 0.7000000000000001], [0.4, 0.1]], 'status': 'ok'}, {'loss': 2.054909975100184, 'params': [[0.9, 0.8], [0.6000000000000001, 0.0]], 'status': 'ok'}, {'loss': 2.109084635592211, 'params': [[0.0, 0.1], [0.9, 0.5]], 'status': 'ok'}, {'loss': 0.908515294085452, 'params': [[0.2, 0.0], [0.9, 0.30000000000000004]], 'status': 'ok'}, {'loss': 1.9878040138509137, 'params': [[0.2, 0.0], [0.9, 0.1]], 'status': 'ok'}, {'loss': 1.4866143589077754, 'params': [[0.2, 0.0], [0.9, 0.2]], 'status': 'ok'}, {'loss': 0.908515294085452, 'params': [[0.2, 0.0], [0.9, 0.30000000000000004]], 'status': 'ok'}, {'loss': 2.028782314604828, 'params': [[0.30000000000000004, 0.0], [0.7000000000000001, 0.4]], 'status': 'ok'}, {'loss': 3.2906739337257926, 'params': [[0.2, 0.6000000000000001], [0.2, 0.30000000000000004]], 'status': 'ok'}, {'loss': 3.0570591737178705, 'params': [[0.5, 0.1], [0.6000000000000001, 0.6000000000000001]], 'status': 'ok'}, {'loss': 1.0308331145782181, 'params': [[0.2, 0.7000000000000001], [0.9, 0.8]], 'status': 'ok'}, {'loss': 2.102473973466009, 'params': [[0.9, 0.8], [0.0, 0.30000000000000004]], 'status': 'ok'}, {'loss': 3.0425369148527306, 'params': [[0.1, 0.0], [0.4, 0.0]], 'status': 'ok'}, {'loss': 1.9862783651376328, 'params': [[0.7000000000000001, 0.5], [0.30000000000000004, 0.5]], 'status': 'ok'}, {'loss': 0.5376836248905036, 'params': [[0.6000000000000001, 0.4], [0.1, 0.1]], 'status': 'ok'}, {'loss': 0.5376836248905036, 'params': [[0.6000000000000001, 0.4], [0.1, 0.1]], 'status': 'ok'}, {'loss': 0.5376836248905036, 'params': [[0.6000000000000001, 0.4], [0.1, 0.1]], 'status': 'ok'}, {'loss': 0.5376836248905036, 'params': [[0.6000000000000001, 0.4], [0.1, 0.1]], 'status': 'ok'}, {'loss': 0.5376836248905036, 'params': [[0.6000000000000001, 0.4], [0.1, 0.1]], 'status': 'ok'}, {'loss': 0.5376836248905036, 'params': [[0.6000000000000001, 0.4], [0.1, 0.1]], 'status': 'ok'}, {'loss': 0.5376836248905036, 'params': [[0.6000000000000001, 0.4], [0.1, 0.1]], 'status': 'ok'}, {'loss': 3.442249496747409, 'params': [[0.6000000000000001, 0.4], [0.8, 0.1]], 'status': 'ok'}, {'loss': 2.5846255757933014, 'params': [[0.4, 0.30000000000000004], [0.1, 0.4]], 'status': 'ok'}, {'loss': 2.6532297466953216, 'params': [[0.30000000000000004, 0.4], [0.7000000000000001, 0.2]], 'status': 'ok'}, {'loss': 3.504418716696098, 'params': [[0.6000000000000001, 0.9], [0.1, 0.9]], 'status': 'ok'}, {'loss': 2.6960905399001054, 'params': [[0.5, 0.4], [0.30000000000000004, 0.1]], 'status': 'ok'}, {'loss': 2.081530343047651, 'params': [[0.6000000000000001, 0.5], [0.1, 0.6000000000000001]], 'status': 'ok'}, {'loss': 1.7569204732676127, 'params': [[0.8, 0.6000000000000001], [0.2, 0.7000000000000001]], 'status': 'ok'}, {'loss': 2.146456890181656, 'params': [[0.4, 0.1], [0.0, 0.1]], 'status': 'ok'}, {'loss': 2.446904194795047, 'params': [[0.6000000000000001, 0.30000000000000004], [0.8, 0.8]], 'status': 'ok'}, {'loss': 3.194891736603643, 'params': [[0.9, 0.4], [0.4, 0.9]], 'status': 'ok'}, {'loss': 3.3467507126550395, 'params': [[0.1, 0.7000000000000001], [0.1, 0.4]], 'status': 'ok'}, {'loss': 3.2686833266151534, 'params': [[0.7000000000000001, 0.9], [0.7000000000000001, 0.2]], 'status': 'ok'}, {'loss': 3.302011272630335, 'params': [[0.30000000000000004, 0.8], [0.1, 0.5]], 'status': 'ok'}, {'loss': 0.4573864445074372, 'params': [[0.8, 0.4], [0.2, 0.1]], 'status': 'ok'}, {'loss': 0.474010817027631, 'params': [[0.8, 0.5], [0.2, 0.0]], 'status': 'ok'}, {'loss': 0.474010817027631, 'params': [[0.8, 0.5], [0.2, 0.0]], 'status': 'ok'}, {'loss': 0.474010817027631, 'params': [[0.8, 0.5], [0.2, 0.0]], 'status': 'ok'}, {'loss': 0.474010817027631, 'params': [[0.8, 0.5], [0.2, 0.0]], 'status': 'ok'}, {'loss': 0.474010817027631, 'params': [[0.8, 0.5], [0.2, 0.0]], 'status': 'ok'}, {'loss': 0.474010817027631, 'params': [[0.8, 0.5], [0.2, 0.0]], 'status': 'ok'}, {'loss': 0.474010817027631, 'params': [[0.8, 0.5], [0.2, 0.0]], 'status': 'ok'}, {'loss': 0.474010817027631, 'params': [[0.8, 0.5], [0.2, 0.0]], 'status': 'ok'}, {'loss': 0.474010817027631, 'params': [[0.8, 0.5], [0.2, 0.0]], 'status': 'ok'}, {'loss': 0.474010817027631, 'params': [[0.8, 0.5], [0.2, 0.0]], 'status': 'ok'}, {'loss': 1.2601909219484422, 'params': [[0.8, 0.6000000000000001], [0.2, 0.6000000000000001]], 'status': 'ok'}, {'loss': 3.1400237126068653, 'params': [[0.8, 0.1], [0.2, 0.7000000000000001]], 'status': 'ok'}, {'loss': 2.163542362271541, 'params': [[0.8, 0.7000000000000001], [0.2, 0.8]], 'status': 'ok'}, {'loss': 0.3151913144719921, 'params': [[0.5, 0.5], [0.0, 0.0]], 'status': 'ok'}, {'loss': 2.3282264296022155, 'params': [[0.5, 0.30000000000000004], [0.0, 0.5]], 'status': 'ok'}, {'loss': 3.644942888110179, 'params': [[0.5, 0.8], [0.0, 0.9]], 'status': 'ok'}]
#[{'loss': 3.132745423465832, 'params': [[0.9, 0.0], [0.7000000000000001, 0.4]], 'status': 'ok'}, {'loss': 2.4699504526949037, 'params': [[0.2, 0.4], [0.9, 0.1]], 'status': 'ok'}, {'loss': 3.0820581942438974, 'params': [[0.8, 0.9], [0.7000000000000001, 0.2]], 'status': 'ok'}, {'loss': 2.3713218516156944, 'params': [[0.30000000000000004, 0.6000000000000001], [0.0, 0.30000000000000004]], 'status': 'ok'}, {'loss': 100, 'params': [[0.0, 0.30000000000000004], [0.2, 0.4]], 'status': 'fail'}, {'loss': 3.1088415733791455, 'params': [[0.2, 0.4], [0.0, 0.7000000000000001]], 'status': 'ok'}, {'loss': 100, 'params': [[0.8, 0.5], [0.8, 0.7000000000000001]], 'status': 'fail'}, {'loss': 2.440902231108139, 'params': [[0.5, 0.5], [0.8, 0.8]], 'status': 'ok'}, {'loss': 1.2645201658597331, 'params': [[0.0, 0.2], [0.5, 0.30000000000000004]], 'status': 'ok'}, {'loss': 3.135424992348325, 'params': [[0.6000000000000001, 0.1], [0.4, 0.6000000000000001]], 'status': 'ok'}, {'loss': 1.417017448397006, 'params': [[0.0, 0.4], [0.5, 0.7000000000000001]], 'status': 'ok'}, {'loss': 100, 'params': [[0.4, 0.9], [0.30000000000000004, 0.7000000000000001]], 'status': 'fail'}, {'loss': 3.1272951125253927, 'params': [[0.4, 0.2], [0.1, 0.7000000000000001]], 'status': 'ok'}, {'loss': 100, 'params': [[0.8, 0.4], [0.7000000000000001, 0.4]], 'status': 'fail'}, {'loss': 3.1047242667547774, 'params': [[0.4, 0.5], [0.6000000000000001, 0.9]], 'status': 'ok'}, {'loss': 100, 'params': [[0.30000000000000004, 0.7000000000000001], [0.30000000000000004, 0.9]], 'status': 'fail'}, {'loss': 3.137078478899898, 'params': [[0.8, 0.30000000000000004], [0.8, 0.7000000000000001]], 'status': 'ok'}, {'loss': 2.602947218772552, 'params': [[0.9, 0.9], [0.1, 0.2]], 'status': 'ok'}, {'loss': 3.1415681631001346, 'params': [[0.5, 0.9], [0.2, 0.9]], 'status': 'ok'}, {'loss': 1.891440970142701, 'params': [[0.8, 0.30000000000000004], [0.0, 0.6000000000000001]], 'status': 'ok'}, {'loss': 1.2645201658597331, 'params': [[0.0, 0.2], [0.5, 0.30000000000000004]], 'status': 'ok'}, {'loss': 1.8653031508726992, 'params': [[0.1, 0.2], [0.5, 0.30000000000000004]], 'status': 'ok'}, {'loss': 2.929105704903253, 'params': [[0.7000000000000001, 0.8], [0.5, 0.5]], 'status': 'ok'}, {'loss': 1.2645201658597331, 'params': [[0.0, 0.2], [0.5, 0.30000000000000004]], 'status': 'ok'}, {'loss': 2.5553522248192584, 'params': [[0.0, 0.2], [0.5, 0.0]], 'status': 'ok'}, {'loss': 1.2645201658597331, 'params': [[0.0, 0.2], [0.5, 0.30000000000000004]], 'status': 'ok'}, {'loss': 0.49063087087832025, 'params': [[0.0, 0.2], [0.6000000000000001, 0.30000000000000004]], 'status': 'ok'}, {'loss': 3.118720570614099, 'params': [[0.7000000000000001, 0.0], [0.6000000000000001, 0.8]], 'status': 'ok'}, {'loss': 3.1280667840618284, 'params': [[0.6000000000000001, 0.6000000000000001], [0.6000000000000001, 0.30000000000000004]], 'status': 'ok'}, {'loss': 3.1233642960815864, 'params': [[0.1, 0.7000000000000001], [0.4, 0.1]], 'status': 'ok'}, {'loss': 2.3286070080315935, 'params': [[0.9, 0.8], [0.6000000000000001, 0.0]], 'status': 'ok'}, {'loss': 3.2287419419610393, 'params': [[0.0, 0.1], [0.9, 0.5]], 'status': 'ok'}, {'loss': 0.9024282260187819, 'params': [[0.2, 0.0], [0.9, 0.30000000000000004]], 'status': 'ok'}, {'loss': 2.048956873362839, 'params': [[0.2, 0.0], [0.9, 0.1]], 'status': 'ok'}, {'loss': 1.5043117437460403, 'params': [[0.2, 0.0], [0.9, 0.2]], 'status': 'ok'}, {'loss': 0.9024282260187819, 'params': [[0.2, 0.0], [0.9, 0.30000000000000004]], 'status': 'ok'}, {'loss': 2.2278090966931465, 'params': [[0.30000000000000004, 0.0], [0.7000000000000001, 0.4]], 'status': 'ok'}, {'loss': 3.112445796720727, 'params': [[0.2, 0.6000000000000001], [0.2, 0.30000000000000004]], 'status': 'ok'}, {'loss': 3.1320172204091596, 'params': [[0.5, 0.1], [0.6000000000000001, 0.6000000000000001]], 'status': 'ok'}, {'loss': 1.002838614670062, 'params': [[0.2, 0.7000000000000001], [0.9, 0.8]], 'status': 'ok'}, {'loss': 3.1552646065927945, 'params': [[0.9, 0.8], [0.0, 0.30000000000000004]], 'status': 'ok'}, {'loss': 3.132656079849628, 'params': [[0.1, 0.0], [0.4, 0.0]], 'status': 'ok'}, {'loss': 2.201228130957778, 'params': [[0.7000000000000001, 0.5], [0.30000000000000004, 0.5]], 'status': 'ok'}, {'loss': 0.5704588788166428, 'params': [[0.6000000000000001, 0.4], [0.1, 0.1]], 'status': 'ok'}, {'loss': 0.5704588788166428, 'params': [[0.6000000000000001, 0.4], [0.1, 0.1]], 'status': 'ok'}, {'loss': 0.5704588788166428, 'params': [[0.6000000000000001, 0.4], [0.1, 0.1]], 'status': 'ok'}, {'loss': 0.5704588788166428, 'params': [[0.6000000000000001, 0.4], [0.1, 0.1]], 'status': 'ok'}, {'loss': 100, 'params': [[0.6000000000000001, 0.4], [0.8, 0.4]], 'status': 'fail'}, {'loss': 2.3624102439852157, 'params': [[0.4, 0.30000000000000004], [0.1, 0.2]], 'status': 'ok'}, {'loss': 3.158635113570345, 'params': [[0.30000000000000004, 0.4], [0.6000000000000001, 0.1]], 'status': 'ok'}, {'loss': 3.1381641709494272, 'params': [[0.5, 0.6000000000000001], [0.7000000000000001, 0.9]], 'status': 'ok'}, {'loss': 2.6378556498335772, 'params': [[0.6000000000000001, 0.5], [0.2, 0.6000000000000001]], 'status': 'ok'}, {'loss': 2.0254909323890273, 'params': [[0.0, 0.2], [0.30000000000000004, 0.8]], 'status': 'ok'}, {'loss': 3.111361340460788, 'params': [[0.4, 0.9], [0.1, 0.7000000000000001]], 'status': 'ok'}, {'loss': 0.5678823341417483, 'params': [[0.8, 0.1], [0.0, 0.1]], 'status': 'ok'}, {'loss': 1.9622440566778026, 'params': [[0.8, 0.1], [0.0, 0.4]], 'status': 'ok'}, {'loss': 0.9450713811304612, 'params': [[0.8, 0.1], [0.0, 0.2]], 'status': 'ok'}, {'loss': 3.2392333810164526, 'params': [[0.8, 0.1], [0.0, 0.9]], 'status': 'ok'}, {'loss': 2.382680732646217, 'params': [[0.8, 0.1], [0.0, 0.5]], 'status': 'ok'}, {'loss': 1.526989659887383, 'params': [[0.0, 0.2], [0.8, 0.0]], 'status': 'ok'}, {'loss': 3.143593167715891, 'params': [[0.8, 0.30000000000000004], [0.6000000000000001, 0.6000000000000001]], 'status': 'ok'}, {'loss': 0.6075974001555854, 'params': [[0.9, 0.7000000000000001], [0.0, 0.7000000000000001]], 'status': 'ok'}, {'loss': 2.409201799419446, 'params': [[0.7000000000000001, 0.9], [0.4, 0.1]], 'status': 'ok'}, {'loss': 1.2252426337266384, 'params': [[0.1, 0.2], [0.6000000000000001, 0.30000000000000004]], 'status': 'ok'}, {'loss': 3.0342494813864382, 'params': [[0.30000000000000004, 0.8], [0.7000000000000001, 0.8]], 'status': 'ok'}, {'loss': 0.5704588788166428, 'params': [[0.6000000000000001, 0.4], [0.1, 0.1]], 'status': 'ok'}, {'loss': 100, 'params': [[0.0, 0.1], [0.2, 0.1]], 'status': 'fail'}, {'loss': 1.078828185514717, 'params': [[0.8, 0.5], [0.30000000000000004, 0.1]], 'status': 'ok'}, {'loss': 100, 'params': [[0.5, 0.2], [0.6000000000000001, 0.1]], 'status': 'fail'}, {'loss': 1.962244002861122, 'params': [[0.0, 0.4], [0.8, 0.1]], 'status': 'ok'}, {'loss': 0.7628599710120445, 'params': [[0.4, 0.6000000000000001], [0.0, 0.1]], 'status': 'ok'}, {'loss': 3.1240783627298554, 'params': [[0.6000000000000001, 0.1], [0.4, 0.9]], 'status': 'ok'}, {'loss': 2.1527048679434975, 'params': [[0.9, 0.7000000000000001], [0.1, 0.30000000000000004]], 'status': 'ok'}, {'loss': 100, 'params': [[0.7000000000000001, 0.30000000000000004], [0.6000000000000001, 0.5]], 'status': 'fail'}, {'loss': 0.0050022644593189745, 'params': [[0.1, 0.2], [0.7000000000000001, 0.4]], 'status': 'ok'}, {'loss': 0.0050022644593189745, 'params': [[0.1, 0.2], [0.7000000000000001, 0.4]], 'status': 'ok'}, {'loss': 0.0050022644593189745, 'params': [[0.1, 0.2], [0.7000000000000001, 0.4]], 'status': 'ok'}, {'loss': 0.0050022644593189745, 'params': [[0.1, 0.2], [0.7000000000000001, 0.4]], 'status': 'ok'}, {'loss': 0.0050022644593189745, 'params': [[0.1, 0.2], [0.7000000000000001, 0.4]], 'status': 'ok'}, {'loss': 0.0050022644593189745, 'params': [[0.1, 0.2], [0.7000000000000001, 0.4]], 'status': 'ok'}]

f = partial(calculate_fracture, return_all=False)

n_iter = 80

options_dict = {
    0: list(np.arange(0, 1.0, 0.1)),
    1: list(np.arange(0, 1.0, 0.1)),
    2: list(np.arange(0, 1.0, 0.1)),
    3: list(np.arange(0, 1.0, 0.1)),
}
# пространство поиска
search_space = {
    0: hp.choice(label='x_0', options=options_dict[0]),
    1: hp.choice(label='y_0', options=options_dict[1]),
    2: hp.choice(label='x_1', options=options_dict[2]),
    3: hp.choice(label='y_1', options=options_dict[3]),
}
# история поиска
trials = Trials()

best = fmin(
    # функция для оптимизации
    fn=f,
    # пространство поиска гиперпараметров
    space=search_space,
    # алгоритм поиска
    algo=tpe.suggest,
    # число итераций
    max_evals=n_iter,
    # куда сохранять историю поиска
    trials=trials,
    # random state
    rstate=np.random.default_rng(21),
    # progressbar
    show_progressbar=True)

print(trials.results)

# вывод таблицы (если есть pandas)
data = pd.DataFrame(trials.results)
print(data) # напечатает таблицу

minimum = min(data.loss)
min_idx = data[abs(data['loss'] - minimum) < 1e-10].index
buf = data.loc[min_idx, 'params']
res = [buf[0][0], buf[0][1], buf[1][0], buf[1][1]]

compare_result(calculate_fracture(res, return_all=True))



